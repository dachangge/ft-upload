"use strict";function t(t){return t&&"object"==typeof t&&"default"in t?t.default:t}var e=t(require("ali-oss")),a=t(require("axios")),i=function(){return(i=Object.assign||function(t){for(var e,a=1,i=arguments.length;a<i;a++)for(var r in e=arguments[a])Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t}).apply(this,arguments)};function r(t,e,a,i){return new(a||(a=Promise))((function(r,o){function n(t){try{l(i.next(t))}catch(t){o(t)}}function s(t){try{l(i.throw(t))}catch(t){o(t)}}function l(t){var e;t.done?r(t.value):(e=t.value,e instanceof a?e:new a((function(t){t(e)}))).then(n,s)}l((i=i.apply(t,e||[])).next())}))}function o(t,e){var a,i,r,o,n={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(a)throw new TypeError("Generator is already executing.");for(;n;)try{if(a=1,i&&(r=2&o[0]?i.return:o[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,o[1])).done)return r;switch(i=0,r&&(o=[2&o[0],r.value]),o[0]){case 0:case 1:r=o;break;case 4:return n.label++,{value:o[1],done:!1};case 5:n.label++,i=o[1],o=[0];continue;case 7:o=n.ops.pop(),n.trys.pop();continue;default:if(!(r=n.trys,(r=r.length>0&&r[r.length-1])||6!==o[0]&&2!==o[0])){n=0;continue}if(3===o[0]&&(!r||o[1]>r[0]&&o[1]<r[3])){n.label=o[1];break}if(6===o[0]&&n.label<r[1]){n.label=r[1],r=o;break}if(r&&n.label<r[2]){n.label=r[2],n.ops.push(o);break}r[2]&&n.ops.pop(),n.trys.pop();continue}o=e.call(t,n)}catch(t){o=[6,t],i=0}finally{a=r=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function n(t){var e="function"==typeof Symbol&&Symbol.iterator,a=e&&t[e],i=0;if(a)return a.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&i>=t.length&&(t=void 0),{value:t&&t[i++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")}function s(t,e){var a="function"==typeof Symbol&&t[Symbol.iterator];if(!a)return t;var i,r,o=a.call(t),n=[];try{for(;(void 0===e||e-- >0)&&!(i=o.next()).done;)n.push(i.value)}catch(t){r={error:t}}finally{try{i&&!i.done&&(a=o.return)&&a.call(o)}finally{if(r)throw r.error}}return n}var l;!function(t){t[t.alicloud=0]="alicloud",t[t.huaweicloud=1]="huaweicloud",t[t.production=2]="production"}(l||(l={}));var c,p={alicloud:{version:l.alicloud,directUrl:"/a/oss/policy",secretKeyUrl:"/a/oss/getTempToken"},huaweicloud:{version:l.huaweicloud,directUrl:"/a/obs/policy",secretKeyUrl:"/a/obs/getTempToken",fileResUrl:"/a/common"}},u={"7z":"application/x-7z-compressed",aac:"audio/x-aac",ai:"application/postscript",aif:"audio/x-aiff",asc:"text/plain",asf:"video/x-ms-asf",atom:"application/atom+xml",avi:"video/x-msvideo",bmp:"image/bmp",bz2:"application/x-bzip2",cer:"application/pkix-cert",crl:"application/pkix-crl",crt:"application/x-x509-ca-cert",css:"text/css",csv:"text/csv",cu:"application/cu-seeme",deb:"application/x-debian-package",doc:"application/msword",docx:"application/vnd.openxmlformats-officedocument.wordprocessingml.document",dvi:"application/x-dvi",eot:"application/vnd.ms-fontobject",eps:"application/postscript",epub:"application/epub+zip",etx:"text/x-setext",flac:"audio/flac",flv:"video/x-flv",gif:"image/gif",gz:"application/gzip",htm:"text/html",html:"text/html",ico:"image/x-icon",ics:"text/calendar",ini:"text/plain",iso:"application/x-iso9660-image",jar:"application/java-archive",jpe:"image/jpeg",jpeg:"image/jpeg",jpg:"image/jpeg",js:"text/javascript",json:"application/json",latex:"application/x-latex",log:"text/plain",m4a:"audio/mp4",m4v:"video/mp4",mid:"audio/midi",midi:"audio/midi",mov:"video/quicktime",mp3:"audio/mpeg",mp4:"video/mp4",mp4a:"audio/mp4",mp4v:"video/mp4",mpe:"video/mpeg",mpeg:"video/mpeg",mpg:"video/mpeg",mpg4:"video/mp4",oga:"audio/ogg",ogg:"audio/ogg",ogv:"video/ogg",ogx:"application/ogg",pbm:"image/x-portable-bitmap",pdf:"application/pdf",pgm:"image/x-portable-graymap",png:"image/png",pnm:"image/x-portable-anymap",ppm:"image/x-portable-pixmap",ppt:"application/vnd.ms-powerpoint",pptx:"application/vnd.openxmlformats-officedocument.presentationml.presentation",ps:"application/postscript",qt:"video/quicktime",rar:"application/x-rar-compressed",ras:"image/x-cmu-raster",rss:"application/rss+xml",rtf:"application/rtf",sgm:"text/sgml",sgml:"text/sgml",svg:"image/svg+xml",swf:"application/x-shockwave-flash",tar:"application/x-tar",tif:"image/tiff",tiff:"image/tiff",torrent:"application/x-bittorrent",ttf:"application/x-font-ttf",txt:"text/plain",wav:"audio/x-wav",webm:"video/webm",wma:"audio/x-ms-wma",wmv:"video/x-ms-wmv",woff:"application/x-font-woff",wsdl:"application/wsdl+xml",xbm:"image/x-xbitmap",xls:"application/vnd.ms-excel",xlsx:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",xml:"application/xml",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump",yaml:"text/yaml",yml:"text/yaml",zip:"application/zip"};a.interceptors.response.use((function(t){return 200===t.status?t.data.success?t.data:Promise.reject(t.data):Promise.reject({data:t.data,status:t.status,statusText:t.statusText,headers:t.headers,config:t.config})}),(function(t){return Promise.reject(t)})),a.interceptors.request.use((function(t){return t.withCredentials||!1===t.withCredentials||(t.withCredentials=!0),t})),function(t){t.ready="ready",t.uploading="uploading",t.success="success",t.fail="fail"}(c||(c={}));var d=function(){function t(t){var e=this;if(this.canceledUidList=[],this.config=p.alicloud,this.partSize=10,this.uploadFiles=new Map,!t)throw new Error("UploadHelper构造函数 需要一个 对象参数");if(t.urlConfig&&"[object Object]"===Object.prototype.toString.call(t.urlConfig)){if(!t.urlConfig.directUrl)throw new Error('传入的api参数对象，未提供文件直传所需地址参数 "directUrl"');if(!t.urlConfig.secretKeyUrl)throw new Error('传入的api参数对象，未提供大附件上传所需的临时秘钥地址参数 "secretKeyUrl"');this.config=t.urlConfig}else this.config=p[t.version||process.env.VUE_APP_version||"alicloud"];this.config=this.config||p.alicloud,Object.keys(this.config).forEach((function(a){var i=e.config[a];"version"!==a&&0!==i.indexOf("http")&&(e.config[a]=t.baseUrl?t.baseUrl+i:process.env.VUE_APP_html_url+i)})),t.partSize&&"number"==typeof t.partSize&&(this.partSize=t.partSize),this.progressFn=t.progressFn,this.params=t.params}return t.prototype.add=function(t){var e=this;Array.isArray(t)?t.forEach((function(t){t.status=c.ready,e.uploadFiles.set(t,null)})):(t.status=c.ready,this.uploadFiles.set(t,null))},t.prototype.submit=function(t){return r(this,void 0,void 0,(function(){var r,n=this;return o(this,(function(o){if(!t)throw new Error("参数必须是 文件类型");return t.size>1073741824?[2,Promise.reject("文件大小不能超过1G")]:(this.uploadFiles.has(t)||this.uploadFiles.set(t,null),t.status=c.uploading,(r=this.params.bucketType)||(r=+(t.size>31457280)),t.size<31457280?[2,a.get(this.config.directUrl,{params:i(i({},this.params),{bucketType:r})}).then((function(e){if(n.config.version===l.alicloud){var a=i({name:t.name,key:e.data.dir+"/"+t.name,policy:e.data.policy,OSSAccessKeyId:e.data.accessid,signature:e.data.signature,callback:e.data.callbackSig,expire:e.data.expire},e.data.callvackVarMap);return n.derictUpload(e.data.host,a,t)}if(n.config.version===l.huaweicloud){var r=t.name.slice(t.name.lastIndexOf(".")+1);a=i(i({},e.data),{name:t.name,"content-type":u[r]});return n.derictUpload(e.data.host,a,t)}return""})).catch((function(e){return t.status=c.fail,n.progressFn(0,t),Promise.reject(e)}))]:[2,a.get(this.config.secretKeyUrl,{params:i(i({},this.params),{bucketType:r})}).then((function(o){if(n.config.version===l.alicloud){var s={accessKeyId:o.data.ak,accessKeySecret:o.data.sk,stsToken:o.data.token,bucket:o.data.bucket,timeout:6e5};n.client=new e(s);var c=n.client;return n.uploadFiles.set(t,n.client.cancel.bind(c)),a.get(n.config.directUrl,{params:i(i({},n.params),{bucketType:r})}).then((function(e){return n.ossMultipartUpload(t,o.data.callbackUrl,e.data.dir)}))}}))])}))}))},t.prototype.concurrenceSubmitAll=function(){return Promise.resolve([])},t.prototype.secondarySubmitAll=function(t){return r(this,void 0,void 0,(function(){var e,a,i,r,l,p,u,d,f,m,h,g,v;return o(this,(function(o){switch(o.label){case 0:if(!t){t=[];try{for(e=n(this.uploadFiles),a=e.next();!a.done;a=e.next())i=s(a.value,2),r=i[0],i[1],r.status===c.ready&&t.push(r)}catch(t){m={error:t}}finally{try{a&&!a.done&&(h=e.return)&&h.call(e)}finally{if(m)throw m.error}}}if(!t||0===t.length)return[2,Promise.reject("当前没有可以上传的文件")];l=[],o.label=1;case 1:o.trys.push([1,6,7,8]),p=n(t),u=p.next(),o.label=2;case 2:return u.done?[3,5]:(d=u.value,this.uploadFiles.has(d)?[4,this.submit(d)]:[3,4]);case 3:o.sent(),l.push(d),o.label=4;case 4:return u=p.next(),[3,2];case 5:return[3,8];case 6:return f=o.sent(),g={error:f},[3,8];case 7:try{u&&!u.done&&(v=p.return)&&v.call(p)}finally{if(g)throw g.error}return[7];case 8:return[2,Promise.resolve(l)]}}))}))},t.prototype.submitAll=function(t){return this.secondarySubmitAll(t)},t.prototype.derictUpload=function(t,e,i){var r=new FormData;Object.keys(e).forEach((function(t){r.append(t,e[t])})),r.append("file",i.raw,i.raw.name);var o=this.progressFn,n=this;return a({url:t,method:"post",data:r,withCredentials:!1,cancelToken:new a.CancelToken((function(t){n.uploadFiles.set(i,t)})),onUploadProgress:function(t){var e=0;t.total>0&&(e=Math.floor(t.loaded/t.total*100)),i.status=c.uploading,o(e,i)}}).then((function(t){return t instanceof a.Cancel?"上传任务已经被取消":(i.status=c.success,i.response={url:t.data||Reflect.get(t,"url")},i.keyCode=Reflect.get(t,"key"),o(100,i),t)})).catch((function(t){return i.status=c.fail,o(0,i),Promise.reject(t)}))},t.prototype.abort=function(t){var e=this.uploadFiles.get(t);return e&&e(),this.uploadFiles.has(t)&&this.uploadFiles.delete(t),Promise.resolve()},t.prototype.clearAllFiles=function(){var t=this;Array.from(this.uploadFiles).forEach((function(e){var a=s(e,2),i=a[0],r=a[1];i.status===c.uploading&&r&&r.call(t)})),this.uploadFiles.clear()},t.prototype.ossMultipartUpload=function(t,e,a){return r(this,void 0,void 0,(function(){var i,r,n=this;return o(this,(function(o){switch(o.label){case 0:return o.trys.push([0,2,,3]),[4,this.client.multipartUpload(a+"/"+t.name,t.raw,{partSize:1024*this.partSize*1024,parallel:3,progress:function(e){return n.progressFn(Math.floor(100*e),t)},callback:{body:'{"object":${object},"bucket":${bucket},"buckettype":${x:buckettype}}',url:e,contentType:"application/json",customValue:{buckettype:"1"}}})];case 1:return i=o.sent(),t.status=c.success,t.keyCode=i.data.key,t.response={url:i.data.url},this.progressFn(100,t),[2,t];case 2:return r=o.sent(),t.status=c.fail,[2,Promise.reject(r)];case 3:return[2]}}))}))},t.prototype.getFileList=function(){return Array.from(this.uploadFiles).map((function(t){var e=s(t,2),a=e[0];e[1];return a}))},t}();module.exports=d;
